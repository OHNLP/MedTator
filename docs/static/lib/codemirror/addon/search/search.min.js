!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],e):e(CodeMirror)}(function(p){"use strict";function o(){this.posFrom=this.posTo=this.lastQuery=this.query=null,this.overlay=null}function f(e){return e.state.search||(e.state.search=new o)}function t(e){return"string"==typeof e&&e==e.toLowerCase()}function d(e,o,n){return e.getSearchCursor(o,n,{caseFold:t(o),multiline:!0})}function m(e,o,n,r,t){e.openDialog?e.openDialog(o,t,{value:r,selectValueOnOpen:!0,bottom:e.options.search.bottom}):t(prompt(n,r))}function r(e){return e.replace(/\\([nrt\\])/g,function(e,o){return"n"==o?"\n":"r"==o?"\r":"t"==o?"\t":"\\"==o?"\\":e})}function a(e){var o=e.match(/^\/(.*)\/([a-z]*)$/);if(o)try{e=new RegExp(o[1],-1==o[2].indexOf("i")?"":"i")}catch(e){}else e=r(e);return e=("string"==typeof e?""==e:e.test(""))?/x^/:e}function y(e,o,n){var r;o.queryText=n,o.query=a(n),e.removeOverlay(o.overlay,t(o.query)),o.overlay=(r=o.query,n=t(o.query),"string"==typeof r?r=new RegExp(r.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),n?"gi":"g"):r.global||(r=new RegExp(r.source,r.ignoreCase?"gi":"g")),{token:function(e){r.lastIndex=e.pos;var o=r.exec(e.string);if(o&&o.index==e.pos)return e.pos+=o[0].length||1,"searching";o?e.pos=o.index:e.skipToEnd()}}),e.addOverlay(o.overlay),e.showMatchesOnScrollbar&&(o.annotate&&(o.annotate.clear(),o.annotate=null),o.annotate=e.showMatchesOnScrollbar(o.query,t(o.query)))}function n(t,o,e,n){var r=f(t);if(r.query)return h(t,o);var a,s,i,c,l,u=t.getSelection()||r.lastQuery;u instanceof RegExp&&"x^"==u.source&&(u=null),e&&t.openDialog?(a=null,s=function(e,o){p.e_stop(o),e&&(e!=r.queryText&&(y(t,r,e),r.posFrom=r.posTo=t.getCursor()),a&&(a.style.opacity=1),h(t,o.shiftKey,function(e,o){var n;o.line<3&&document.querySelector&&(n=t.display.wrapper.querySelector(".CodeMirror-dialog"))&&n.getBoundingClientRect().bottom-4>t.cursorCoords(o,"window").top&&((a=n).style.opacity=.4)}))},c=x(i=t),l=u,e=function(e,o){var n=p.keyName(e),r=t.getOption("extraKeys"),n=r&&r[n]||p.keyMap[t.getOption("keyMap")][n];"findNext"==n||"findPrev"==n||"findPersistentNext"==n||"findPersistentPrev"==n?(p.e_stop(e),y(t,f(t),o),t.execCommand(n)):"find"!=n&&"findPersistent"!=n||(p.e_stop(e),s(o,e))},i.openDialog(c,s,{value:l,selectValueOnOpen:!0,closeOnEnter:!1,onClose:function(){g(i)},onKeyDown:e,bottom:i.options.search.bottom}),n&&u&&(y(t,r,u),h(t,o))):m(t,x(t),"Search for:",u,function(e){e&&!r.query&&t.operation(function(){y(t,r,e),r.posFrom=r.posTo=t.getCursor(),h(t,o)})})}function h(n,r,t){n.operation(function(){var e=f(n),o=d(n,e.query,r?e.posFrom:e.posTo);(o.find(r)||(o=d(n,e.query,r?p.Pos(n.lastLine()):p.Pos(n.firstLine(),0))).find(r))&&(n.setSelection(o.from(),o.to()),n.scrollIntoView({from:o.from(),to:o.to()},20),e.posFrom=o.from(),e.posTo=o.to(),t&&t(o.from(),o.to()))})}function g(o){o.operation(function(){var e=f(o);e.lastQuery=e.query,e.query&&(e.query=e.queryText=null,o.removeOverlay(e.overlay),e.annotate&&(e.annotate.clear(),e.annotate=null))})}function x(e){return'<span class="CodeMirror-search-label">'+e.phrase("Search:")+'</span> <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">'+e.phrase("(Use /re/ syntax for regexp search)")+"</span>"}function v(o,r,t){o.operation(function(){for(var n,e=d(o,r);e.findNext();)"string"!=typeof r?(n=o.getRange(e.from(),e.to()).match(r),e.replace(t.replace(/\$(\d)/g,function(e,o){return n[o]}))):e.replace(t)})}function s(u,e){var o,n;u.getOption("readOnly")||(o=u.getSelection()||f(u).lastQuery,n='<span class="CodeMirror-search-label">'+(e?u.phrase("Replace all:"):u.phrase("Replace:"))+"</span>",m(u,n+' <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">'+u.phrase("(Use /re/ syntax for regexp search)")+"</span>",n,o,function(l){l&&(l=a(l),m(u,'<span class="CodeMirror-search-label">'+u.phrase("With:")+'</span> <input type="text" style="width: 10em" class="CodeMirror-search-field"/>',u.phrase("Replace with:"),"",function(a){var s,i,c;a=r(a),e?v(u,l,a):(g(u),s=d(u,l,u.getCursor("from")),i=function(){var e,o,n,r,t=s.from();!(e=s.findNext())&&(s=d(u,l),!(e=s.findNext())||t&&s.from().line==t.line&&s.from().ch==t.ch)||(u.setSelection(s.from(),s.to()),u.scrollIntoView({from:s.from(),to:s.to()}),n='<span class="CodeMirror-search-label">'+(r=o=u).phrase("Replace?")+"</span> <button>"+r.phrase("Yes")+"</button> <button>"+r.phrase("No")+"</button> <button>"+r.phrase("All")+"</button> <button>"+r.phrase("Stop")+"</button> ",t=u.phrase("Replace?"),r=[function(){c(e)},i,function(){v(u,l,a)}],o.openConfirm?o.openConfirm(n,r):confirm(t)&&r[0]())},c=function(n){s.replace("string"==typeof l?a:a.replace(/\$(\d)/g,function(e,o){return n[o]})),i()},i())}))}))}p.defineOption("search",{bottom:!1}),p.commands.find=function(e){g(e),n(e)},p.commands.findPersistent=function(e){g(e),n(e,!1,!0)},p.commands.findPersistentNext=function(e){n(e,!1,!0,!0)},p.commands.findPersistentPrev=function(e){n(e,!0,!0,!0)},p.commands.findNext=n,p.commands.findPrev=function(e){n(e,!0)},p.commands.clearSearch=g,p.commands.replace=s,p.commands.replaceAll=function(e){s(e,!0)}});